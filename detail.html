<?php
include 'config.php';

// ==================== AMBIL PARAMETER ====================
$tahun    = isset($_GET['tahun']) ? intval($_GET['tahun']) : date("Y");
$bulan    = isset($_GET['bulan']) ? intval($_GET['bulan']) : date("n");
$kategori = isset($_GET['kategori']) ? strtoupper($_GET['kategori']) : "TOTAL";

// Nama bulan
$nama_bulan = [
    1=>"Januari", 2=>"Februari", 3=>"Maret", 4=>"April",
    5=>"Mei", 6=>"Juni", 7=>"Juli", 8=>"Agustus",
    9=>"September", 10=>"Oktober", 11=>"November", 12=>"Desember"
];

// Mapping teks panjang → huruf A–F
$map = [
    "Pencatuman dalam daftar pencegahan atau penangkalan" => "A",
    "Pembatasan, perubahan, atau pembatalan izin tinggal" => "B",
    "Larangan untuk berada di satu atau beberapa tempat tertentu di Wilayah Indonesia" => "C",
    "Keharusan untuk bertempat tinggal di suatu tempat tertentu di Wilayah Indonesia" => "D",
    "Pengenaan biaya beban" => "E",
    "Deportasi dari Wilayah Indonesia" => "F"
];

// ==================== QUERY ====================
$sql = "SELECT t.*, o.nama, o.jenis_kelamin, o.kewarganegaraan, o.paspor
        FROM tindakan t
        JOIN orang_asing o ON t.orang_asing_id = o.id
        WHERE YEAR(t.tanggal_tindakan) = $tahun";

if ($bulan > 0) {
    $sql .= " AND MONTH(t.tanggal_tindakan) = $bulan";
}

$result = mysqli_query($conn, $sql);

// ==================== DATA ====================
$data = [];
while ($row = mysqli_fetch_assoc($result)) {
    $jenis_raw = $row['jenis_tindakan'];
    $pasal = [];

    foreach (explode(",", $jenis_raw) as $p) {
        $p = trim($p);
        if (in_array($p, ["A","B","C","D","E","F"])) {
            $pasal[] = $p;
        } elseif (isset($map[$p])) {
            $pasal[] = $map[$p];
        }
    }

    if ($kategori != "TOTAL" && !in_array($kategori, $pasal)) {
        continue;
    }

    $row['pasal'] = $pasal;
    $data[] = $row;
}
?>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Detail <?= ($bulan>0 ? $nama_bulan[$bulan]." " : "SEMUA BULAN ") . $tahun; ?></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Include global styles for a modern look -->
  <link rel="stylesheet" href="style.css">
  <!-- Removed inline styles in favour of the global stylesheet -->
</head>
<body>

<div class="container-fluid mt-3">

  <!-- Header -->
  <div class="judul">
    DAFTAR TINDAKAN ADMINISTRATIF KEIMIGRASIAN <br>
    KANTOR IMIGRASI KELAS II TPI LANGSA
  </div>
  <div class="subjudul">
    <?= ($bulan>0 ? strtoupper($nama_bulan[$bulan]) : "SEMUA BULAN") . " " . $tahun; ?>
    (Kategori: <?= $kategori; ?>)
  </div>

  <!-- Tabel -->
  <div class="table-responsive">
    <table class="formal">
      <thead>
        <tr>
          <th class="col-no">NO</th>
          <th class="col-nama">NAMA</th>
          <th class="col-tgl">TANGGAL</th>
          <th class="col-jk">JK</th>
          <th class="col-wn">KEWARGANEGARAAN</th>
          <th class="col-paspor">NO PASPOR</th>
          <th class="col-izin">IZIN TINGGAL</th>
          <th>ALASAN</th>
          <th>PASAL</th>
          <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th>
          <th class="col-ket">KET</th>
        </tr>
      </thead>
      <tbody>
        <?php if (empty($data)): ?>
          <tr><td colspan="16">Tidak ada data</td></tr>
        <?php else: $no=1; foreach ($data as $row): ?>
          <tr>
            <td><?= $no++; ?></td>
            <td style="text-align:left"><?= $row['nama']; ?></td>
            <td><?= date("d-m-Y", strtotime($row['tanggal_tindakan'])); ?></td>
            <td><?= $row['jenis_kelamin']; ?></td>
            <td><?= $row['kewarganegaraan']; ?></td>
            <td><?= $row['paspor']; ?></td>
            <td><?= $row['izin_tinggal'] ?? '-'; ?></td>
            <td style="text-align:left"><?= $row['alasan'] ?? '-'; ?></td>
            <td><?= $row['pasal_75'] ?? '-'; ?></td>
            <td><?= in_array("A",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= in_array("B",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= in_array("C",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= in_array("D",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= in_array("E",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= in_array("F",$row['pasal']) ? "✓" : ""; ?></td>
            <td><?= $row['keterangan'] ?? '-'; ?></td>
          </tr>
        <?php endforeach; endif; ?>
      </tbody>
    </table>
  </div>

  <!-- Keterangan Pasal -->
  <div class="mt-3">
    <h6 style="font-size:13px;"><b>Keterangan Pasal 75 Ayat 2 UU No. 6 Tahun 2011 Tentang Keimigrasian</b></h6>
    <table class="table table-bordered table-sm keterangan">
      <tr style="background:#e8f5e9;">
        <td width="35"><b>A</b></td>
        <td>Pencatuman dalam daftar pencegahan atau penangkalan</td>
      </tr>
      <tr style="background:#f1f8e9;">
        <td><b>B</b></td>
        <td>Pembatasan, perubahan, atau pembatalan izin tinggal</td>
      </tr>
      <tr style="background:#e8f5e9;">
        <td><b>C</b></td>
        <td>Larangan untuk berada di satu atau beberapa tempat tertentu di Wilayah Indonesia</td>
      </tr>
      <tr style="background:#f1f8e9;">
        <td><b>D</b></td>
        <td>Keharusan untuk bertempat tinggal di suatu tempat tertentu di Wilayah Indonesia</td>
      </tr>
      <tr style="background:#e8f5e9;">
        <td><b>E</b></td>
        <td>Pengenaan biaya beban</td>
      </tr>
      <tr style="background:#f1f8e9;">
        <td><b>F</b></td>
        <td>Deportasi dari Wilayah Indonesia</td>
      </tr>
    </table>
  </div>

  <!-- Tombol -->
  <div class="text-center btn-kembali">
    <a href="rekap.php?tahun=<?= $tahun; ?>" class="btn btn-secondary">&larr; Kembali ke Rekap</a>
  </div>

</div>
</body>
</html>
